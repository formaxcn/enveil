# Enveil Options Refactoring

## 项目概述

本项目是对Enveil浏览器扩展的选项页面代码进行了重构，采用了模块化、面向对象的设计模式，将原来的单文件实现拆分为多个功能明确的类，提高了代码的可维护性、可读性和扩展性。

## 重构后的文件结构

```
entrypoints/options/
├── main.ts              # 入口文件，负责初始化应用控制器
├── types.ts             # 共享类型定义
├── managers/            # 功能管理器目录
│   ├── AppController.ts         # 主控制器，协调各个功能模块
│   ├── GitSyncManager.ts        # Git同步功能管理
│   ├── ConfigImportExportManager.ts  # 配置导入导出和备份恢复功能
│   └── SiteEditorManager.ts     # 网站配置编辑功能
├── test/                # 测试目录
│   └── test_refactored_code.ts  # 重构代码的测试脚本
└── README.md            # 本文档
```

## 核心模块说明

### 1. AppController

作为应用的主控制器，协调各个功能模块的工作。主要职责包括：
- 加载和保存应用配置
- 初始化各个功能管理器
- 处理错误和显示通知
- 作为各个模块之间的桥梁

### 2. GitSyncManager

负责Git相关的功能，包括：
- Git仓库配置管理
- 测试Git连接
- 推送配置到Git仓库
- 从Git仓库拉取配置
- 同步配置（先拉取后推送）

### 3. ConfigImportExportManager

处理配置的导入导出和备份恢复功能：
- 导出全部或选定的配置
- 导入配置（支持替换和合并模式）
- 备份Git和同步相关配置
- 恢复备份的配置

### 4. SiteEditorManager

管理网站配置的编辑功能：
- 显示和编辑配置组
- 添加、编辑和删除网站配置
- 管理配置组的启用状态
- 处理用户界面交互

## 测试方法

### 1. 运行单元测试

1. 确保已经安装了项目依赖
2. 在浏览器控制台中运行以下命令：

```javascript
global.runTests();
```

这将执行`test_refactored_code.ts`中的测试用例，验证各个模块的基本功能是否正常。

### 2. 手动测试

1. 构建并加载扩展到浏览器
2. 访问扩展的选项页面
3. 测试各个功能：
   - 配置网站信息
   - 设置Git仓库并进行同步
   - 导入和导出配置
   - 备份和恢复配置

## 功能变更

### 改进

1. **代码结构优化**：从单文件实现拆分为多个功能明确的类
2. **类型安全**：使用TypeScript接口定义所有数据结构
3. **模块化**：各个功能模块相互独立，职责单一
4. **错误处理**：完善的错误捕获和处理机制
5. **可测试性**：代码结构更利于编写单元测试

### 保留的功能

1. 网站环境标记功能
2. Git同步（包括Force Push/Pull）
3. 配置的导入导出（支持全部或选定）
4. 配置备份和恢复
5. 浏览器同步设置

## 注意事项

1. 重构后的代码使用了isomorphic-git包来处理Git操作
2. 确保在构建前安装所有必要的依赖
3. 首次运行时，应用会使用默认配置
4. 测试时，请确保有足够的DOM元素支持各个功能模块

## 未来改进方向

1. 添加更全面的单元测试和集成测试
2. 实现更友好的用户界面
3. 添加更多配置选项和功能
4. 优化Git同步逻辑，减少潜在冲突
5. 添加配置版本历史记录功能